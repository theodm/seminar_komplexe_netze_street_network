<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <script src="https://cdn.jsdelivr.net/npm/ol@v8.2.0/dist/ol.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src=" https://cdn.jsdelivr.net/npm/js-cookie@3.0.5/dist/js.cookie.min.js "></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@v8.2.0/ol.css">
    <!-- Inline JavaScript -->
    <script type="text/javascript">
        document.addEventListener('DOMContentLoaded', function () {

            function cookie_or_default(key, default_value) {
                var value = Cookies.get(key);
                if (!value) {
                    return default_value;
                }
                return value;
            }

            var center = cookie_or_default('last_saved_center_position', "[8.239761, 50.078218]");
            var zoom = cookie_or_default('last_saved_zoom_level', 12);

            var map = new ol.Map({
                target: 'map',
                layers: [
                    new ol.layer.Tile({
                        source: new ol.source.OSM()
                    })
                ],
                view: new ol.View({
                    center: ol.proj.fromLonLat(JSON.parse(center)),
                    zoom: JSON.parse(zoom)
                })
            });

            function getCenter() {
                var center = ol.proj.toLonLat(map.getView().getCenter());
                return [center[0], center[1]];
            }

            function getExtent() {
                var extent = map.getView().calculateExtent(map.getSize());

                var bottomLeft = ol.proj.toLonLat(ol.extent.getBottomLeft(extent));
                var topRight = ol.proj.toLonLat(ol.extent.getTopRight(extent));

                return [
                    topRight[1],
                    topRight[0],
                    bottomLeft[1],
                    bottomLeft[0]
                ]
            }

            // ol on view moved event
            map.getView().on('change:center', function () {
                var center = getCenter();

                document.getElementById('lat').value = center[1];
                document.getElementById('lon').value = center[0];

                // save center point in cookies with js-cookie
                Cookies.set('last_saved_center_position', JSON.stringify(center));
                Cookies.set('last_saved_zoom_level', JSON.stringify(map.getView().getZoom()));

                var extent = getExtent();

                document.getElementById('north').value = extent[0];
                document.getElementById('east').value = extent[1];
                document.getElementById('south').value = extent[2];
                document.getElementById('west').value = extent[3];
            });

            // On GeoSearch Button Click
            document.getElementById('geosearch-button').addEventListener('click', function () {

            });


            const info = document.getElementById('info');

            let currentFeature;
            const displayFeatureInfo = function (pixel, target) {
                const feature = target.closest('.ol-control')
                    ? undefined
                    : map.forEachFeatureAtPixel(pixel, function (feature) {
                        return feature;
                    });
                if (feature) {
                    info.style.left = pixel[0] + 'px';
                    info.style.top = pixel[1] + 'px';
                    if (feature !== currentFeature) {
                        info.style.visibility = 'visible';
                        info.innerText = feature.get('ECO_NAME');
                    }
                } else {
                    info.style.visibility = 'hidden';
                }
                currentFeature = feature;
            };

            map.on("pointermove", function (evt) {
                if (evt.dragging) {
                    return;
                }
            });

            function createGraphOverlay(
                nodes,
                edges
            ) {
                var vectorSource = new ol.source.Vector({
                    features: []
                });

                for (var nid in nodes) {
                    var node = nodes[nid];

                    var feature = new ol.Feature({
                        geometry: new ol.geom.Point(ol.proj.fromLonLat([node.lon, node.lat])),
                        props: node
                    });

                    vectorSource.addFeature(feature);
                }


                // draw edges as multiline
                for (var eid in edges) {
                    var edge = edges[eid];

                    // if edge has no geometry, skip
                    if (!edge.geometry) {
                        console.log("edge " + eid + " has no geometry (" + JSON.stringify(edge) + ")")
                        continue;
                    }

                    const points = [];
                    for (const point of edge.geometry) {
                        points.push(ol.proj.fromLonLat(point));
                    }

                    var feature = new ol.Feature({
                        geometry: new ol.geom.LineString(points),
                        props: edge
                    });

                    console.log(feature)
                    console.log(edge.geometry[0])
                    console.log(edge.geometry[edge.geometry.length - 1])

                    vectorSource.addFeature(feature);
                }

                var vectorLayer = new ol.layer.Vector({
                    source: vectorSource
                });

                map.addLayer(vectorLayer);

                var select = new ol.interaction.Select({
                    layers: [vectorLayer]
                });

                map.addInteraction(select);

                // on select show message
                select.on('select', function (e) {
                    if (!e.target.getFeatures() || e.target.getFeatures().getLength() === 0) {
                        return;
                    }

                    var selectedFeatures = e.target.getFeatures();
                    var coordinates = selectedFeatures.item(0).getGeometry().getCoordinates();
                    var lonLat = ol.proj.toLonLat(coordinates);

                    var props = selectedFeatures.item(0).getProperties().props;

                    alert('You clicked on ' + lonLat[0] + ', ' + lonLat[1] + ' with props ' + JSON.stringify(props));

                });

            }


            // on graph load, request to server /graph
            // with bbox as query parameter (keys: north, east, ...) in axios returns
            // json object with object nodes and edges
            document.getElementById('load-graph-button').addEventListener('click', function () {
                var extent = getExtent();

                var url = '/graph?north=' + extent[0] + '&east=' + extent[1] + '&south=' + extent[2] + '&west=' + extent[3];

                axios.get(url)
                    .then(function (response) {
                        var nodes = response.data.nodes;
                        var edges = response.data.edges;

                        createGraphOverlay(nodes, edges);
                    })
                    .catch(function (error) {
                        console.log(error);
                        alert('Error loading graph');
                    });
            });

            document.getElementById('clear-cookies-button').addEventListener('click', function () {
                Cookies.remove('last_saved_center_position');
                Cookies.remove('last_saved_zoom_level');
            });


        }, false);


    </script>
    <!-- Inline CSS -->
    <style type="text/css">
        /* flex box layout; left should be remaining size right as big as needed */
        #map-and-settings {
            display: flex;
            flex-direction: row;

            height: 98vh;
        }

        #map {
            flex: 1;
        }

        #info {
            position: absolute;
            display: inline-block;
            height: auto;
            width: auto;
            z-index: 100;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 4px;
            padding: 5px;
            left: 50%;
            transform: translateX(3%);
            visibility: hidden;
            pointer-events: none;
        }

        #settings {
            padding: 10px;
        }

        #settings h1 {
            text-align: center;
        }

        .settings-box {
            display: flex;
            flex-direction: column;

            padding: 5px;
        }

        .settings-box label {
            margin-top: 5px;
        }

        .settings-box input {
            margin-top: 2px;
        }


    </style>
</head>
<body>
<div id="map-and-settings">
    <div id="map" class="map">

        <div id="info">
            Testor
        </div>
    </div>
    <div id="settings">
        <h1>Settings</h1>
        <div id="settings-coordinates" class="settings-box">
            <label for="lat">Latitude</label>
            <input type="text" name="lat" id="lat" value="" disabled>
            <label for="lon">Longitude</label>
            <input type="text" name="lon" id="lon" value="" disabled>
        </div>
        <div id="settings-coordinates-bbox" class="settings-box">
            <label for="lat">North</label>
            <input type="text" name="north" id="north" value="" disabled>
            <label for="lon">East</label>
            <input type="text" name="east" id="east" value="" disabled>
            <label for="lat">South</label>
            <input type="text" name="south" id="south" value="" disabled>
            <label for="lon">West</label>
            <input type="text" name="west" id="west" value="" disabled>
        </div>
        <div id="settings-geosearch" class="settings-box">
            <label for="geosearch">Search</label>
            <input type="text" name="geosearch" id="geosearch" value="">
            <input type="button" name="geosearch-button" id="geosearch-button" value="Search">
        </div>
        <div id="settings-buttons" class="settings-box">
            <input type="button" name="load-graph-button" id="load-graph-button" value="Load Graph for BBox">
            <input type="button" name="load-graph-button" id="clear-cookies-button" value="Clear Cookies">
        </div>
    </div>

</body>
</html>